{% load static %}
{% load custom_filters %}
<div class="card shadow-sm p-4">
  <div id="printArea">
    <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-3"
      style="border-color: #dee2e6;">
      <!-- Left: Logo + Name -->
      <div class="d-flex align-items-center gap-2">
        {% if organization.logo %}
        <img src="{{ organization.logo.url }}" alt="Logo"
          style="height: 50px; width: 50px; object-fit: cover; border-radius: 8px; border: 1px solid #ccc;">
        {% else %}
        <div
          style="height: 50px; width: 50px; background-color: #eee; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
          <span class="fw-bold text-muted">N/A</span>
        </div>
        {% endif %}
        <div style="line-height: 1.2;">
          <h5 class="mb-1 fw-bold text-primary" style="font-family: 'Segoe UI', sans-serif;">{{ organization.name }}
          </h5>
          <small class="text-muted" style="font-size: 0.8rem;">Professional Laundry Services</small>
        </div>
      </div>

      <!-- Right: Branch Info -->
      <div class="text-end" style="font-size: 0.8rem; line-height: 1.2;">
        <strong class="text-uppercase text-dark">{{ order.branch.name }}</strong><br>
        <span class="text-muted">{{ order.branch.address|default:"-" }}</span><br>
        üìû <span class="text-dark">{{ organization.phone|default:"N/A" }}</span><br>
        üìß <span class="text-dark">{{ organization.email|default:"N/A" }}</span><br>
        GST: <span class="text-dark">{{ organization.gst_number|default:"N/A" }}</span>
      </div>
    </div>



    <div class="row mb-3">
      <div class="col-sm-6">
        <h6><strong>Bill To:</strong></h6>
        <p><strong><span id="invName">{{ order.customer.name }}</span></strong></p>
        <p>Mobile: <span id="invPhone">{{ order.customer.phone }}</span></p>
        <p>Email: <span id="invEmail">{{ order.customer.email }}</span></p>
      </div>
      <div class="col-sm-6 text-sm-end">
        <h6><strong>Invoice Details:</strong></h6>
        <p>Invoice #: <strong>{{ order.branch.code }}-LPO{{ order.branch_order_number }}</strong></p>

        <p>Date: <strong><span id="invDate">{{ order.created_at|date:"d-m-Y" }}</span></strong></p>
        <p>Time: <strong><span id="invTime">{{ order.created_at|date:"h:i A" }}</span></strong></p>
        <p>Status:
          <strong id="invPaymentStatus" class="{% if order.is_paid %}text-success{% else %}text-warning{% endif %}">
            {% if order.is_paid %}Paid{% else %}Pending{% endif %}
          </strong>
        </p>
      </div>
    </div>

    <h6 class="mb-2">Service Details</h6>
    <table class="table table-bordered">
      <thead class="table-light">
        <tr>
          <th>S.No</th>
          <th>Service Description</th>
          <th>Quantity</th>
          <th>Rate</th>
          <th>Amount (‚Çπ)</th>
        </tr>
      </thead>


      <tbody id="invoiceTableBody">
        {% if weight|is_positive %}
        <tr>
          <td>1</td>
          <td>Washing</td>
          <td>{{ weight }} kg</td>
          <td>
            {% if weight|floatval > 2.99 %}
            ‚Çπ45/kg
            {% else %}
            ‚Çπ50/kg
            {% endif %}
          </td>
          <td>
            {% if weight|floatformat:2 < 3 %} ‚Çπ{{ weight|floatformat:2|floatformat|mul:45|floatformat:2 }} {% else %}
              ‚Çπ{{ weight|floatformat:2|floatformat|mul:50|floatformat:2 }} {% endif %} </td>
        </tr>
        {% endif %}

        {% for item in items %}
        <tr>
          <td>
            {% if weight|is_positive %}
            {{ forloop.counter|add:1 }}
            {% else %}
            {{ forloop.counter }}
            {% endif %}
          </td>
          <td>
            {% if item.service_type == "Dryclean" %}
            Dry Clean - {{ item.description }}
            {% else %}
            Ironing - {{ item.description|safe }}
            {% endif %}
          </td>
          <td>{{ item.qty }}</td>
          <td>‚Çπ{{ item.rate }}</td>
          <td>‚Çπ{{ item.amount }}</td>
        </tr>
        {% endfor %}

      </tbody>





      <tfoot>
        <tr>
          <td colspan="4" class="text-end">Subtotal:</td>
          <td>‚Çπ<span id="invSubtotal">{{ order.total_amount }}</span></td>
        </tr>
        <tr>
          <td colspan="4" class="text-end">Tax (0%):</td>
          <td>‚Çπ0.00</td>
        </tr>
        <tr>
          <td colspan="4" class="text-end">Discount:</td>
          <td>‚Çπ0.00</td>
        </tr>
        <tr>
          <td colspan="4" class="fw-bold text-end">Total Amount:</td>
          <td class="fw-bold text-primary">‚Çπ<span id="invTotal">{{ order.total_amount }}</span></td>
        </tr>
      </tfoot>
    </table>

    <div class="row mt-4">
      <div class="col-sm-6">
        <h6><strong>Terms & Conditions:</strong></h6>
        <ul style="font-size: 0.9rem; padding-left: 18px;">
          <li>Please collect your garments within 7 days</li>
          <li>Items not collected within 30 days will be donated</li>
          <li>We are not responsible for items left in pockets</li>
          <li>Color bleeding is not our responsibility</li>
        </ul>
      </div>
      <div class="col-sm-6 text-sm-end">
        <h6><strong>Payment Information:</strong></h6>
        <p>Payment Method: <span id="invPaymentMethod">{{ order.payment_method }}</span></p>
        <p>Payment Status: <span id="invStatus">{% if order.is_paid %}Paid{% else %}Pending{% endif %}</span></p>
        <p><strong>Thank you for choosing {{ organization.name }}</strong><br><small>Visit us again for quality
            service</small></p>
      </div>
    </div>
  </div>

  <div class="d-flex gap-2 mt-3">
    <button class="btn btn-outline-secondary" onclick="printInvoice()">üñ®Ô∏è Print A4</button>
    <button class="btn btn-outline-dark" onclick="printThermalInvoice()">üßæ Print Thermal</button>
  </div>
</div>

<script>
  function printInvoice() {
    const printContents = document.getElementById("printArea").innerHTML;
    const win = window.open('', '', 'height=600,width=800');
    win.document.write('<html><head><title>Invoice</title>');
    win.document.write('<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">');
    win.document.write('</head><body>');
    win.document.write(printContents);
    win.document.write('</body></html>');
    win.document.close();
    win.print();
  }


  function printThermalInvoice() {
    const name = document.getElementById("invName").innerText;
    const phone = document.getElementById("invPhone").innerText;
    const email = document.getElementById("invEmail").innerText;
    const total = document.getElementById("invTotal").innerText;
    const paymentMethod = document.getElementById("invPaymentMethod").innerText || 'Cash';

    // ‚úÖ Branch name & address from hidden spans
    const branchName = document.getElementById("branchName")?.innerText || "Ultraklean Laundry";
    const branchAddress = document.getElementById("branchAddress")?.innerText || "Electronic City Bengaluru Karnataka";

    const tableRows = [];
    const rows = document.querySelectorAll("#invoiceTableBody tr");

    rows.forEach((row, index) => {
      const cells = row.querySelectorAll("td");
      if (cells.length === 5) {
        tableRows.push(`
        <tr>
          <td>${index + 1}</td>
          <td>${cells[1].innerText}</td>
          <td>${cells[2].innerText}</td>
          <td>${cells[3].innerText}</td>
          <td>${cells[4].innerText}</td>
        </tr>
      `);
      }
    });

    const content = `
  <html>
  <head>
    <title>Thermal Invoice</title>
    <style>
      body { font-family: monospace; font-size: 11px; margin: 0; padding: 0; width: 58mm; }
      .center { text-align: center; }
      table { width: 100%; border-collapse: collapse; }
      td, th { padding: 4px 0; }
      hr { border: none; border-top: 1px dashed #000; margin: 6px 0; }
    </style>
  </head>
  <body>
    <div class="center">
      <h3>üß∫ {{ organization.name }}</h3>
      <p>Branch : {{ order.branch.name }}</p>
      <p>{{ order.branch.address|default:"-" }}</p>
      <p>üìû {{ organization.phone|default:"N/A" }}</p>
      <hr>
      <p><strong>Customer:</strong> ${name}<br>üìû ${phone}<br>‚úâÔ∏è ${email}</p>
      <hr>
    </div>
    <table>
      <tr><th>#</th><th>Item</th><th>Qty</th><th>Rate</th><th>Amt</th></tr>
      ${tableRows.join("")}
    </table>
    <hr>
    <p><strong>Total: ‚Çπ${total}</strong></p>
    <div class="center">
      <p>Payment Method: ${paymentMethod}</p>
      <p>üßº Thank you!</p>
    </div>
  </body>
  </html>
  `;

    const printWindow = window.open('', '', 'width=300,height=600');
    printWindow.document.write(content);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
  }


</script>